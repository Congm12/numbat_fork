<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Numbat is a computational method that infers copy number variations (CNVs) in cancer scRNA-Seq data and reconstructs the tumor phylogeny. The R package integrates signals from gene expression, allelic ratio, and population haplotype structures to accurately infer allele-specific CNVs in single cells and reconstruct their lineage relationship. Numbat can be used to: 1. detect allele-specific copy number variations from single-cells; 2. differentiate tumor versus normal cells in the tumor microenvironment; 3. infer the clonal architecture and evolutionary history of profiled tumors. Numbat does not require tumor/normal-paired DNA or genotype data, but operates solely on the donor scRNA-data data (for example, 10x Cell Ranger output).">
<title>Accurate reconstruction of copy number profiles in scRNAseq data using population haplotype phasing • numbat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Accurate reconstruction of copy number profiles in scRNAseq data using population haplotype phasing">
<meta property="og:description" content="Numbat is a computational method that infers copy number variations (CNVs) in cancer scRNA-Seq data and reconstructs the tumor phylogeny. The R package integrates signals from gene expression, allelic ratio, and population haplotype structures to accurately infer allele-specific CNVs in single cells and reconstruct their lineage relationship. Numbat can be used to: 1. detect allele-specific copy number variations from single-cells; 2. differentiate tumor versus normal cells in the tumor microenvironment; 3. infer the clonal architecture and evolutionary history of profiled tumors. Numbat does not require tumor/normal-paired DNA or genotype data, but operates solely on the donor scRNA-data data (for example, 10x Cell Ranger output).">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">numbat</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header">
<img src="logo.png" class="logo" alt=""><h1 id="numbat">Numbat<a class="anchor" aria-label="anchor" href="#numbat"></a>
</h1>
</div>
<!-- badges: start -->
<!-- badges: end --><p><img src="logo.png" align="right" width="150"></p>
<p>Numbat is a haplotype-enhanced CNV caller from single-cell transcriptomics data. It integrates signals from gene expression, allelic ratio, and population-derived haplotype information to accurately infer allele-specific CNVs in single cells and reconstruct their lineage relationship.</p>
<p>Numbat can be used to:</p>
<ol>
<li>Detect allele-specific copy number variations from scRNA-seq</li>
<li>Differentiate tumor versus normal cells in the tumor microenvironment</li>
<li>Infer the clonal architecture and evolutionary history of profiled tumors.</li>
</ol>
<p><img src="https://user-images.githubusercontent.com/13375875/153020818-2e782689-09db-427f-ad98-2c175021a936.png" alt="image"></p>
<p>Numbat does not require paired DNA or genotype data and operates solely on the donor scRNA-data data (for example, 10x Cell Ranger output). For details of the method, please checkout our preprint:</p>
<p><a href="https://www.biorxiv.org/content/10.1101/2022.02.07.479314v1" class="external-link">Teng Gao, Ruslan Soldatov, Hirak Sarkar, et al. Haplotype-enhanced inference of somatic copy number profiles from single-cell transcriptomes. bioRxiv 2022.</a></p>
</div>
<div class="section level1">
<h1 id="table-of-contents">Table of contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a>
</h1>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#preparing-data">Preparing data</a></li>
<li><a href="#running-numbat">Running Numbat</a></li>
<li><a href="#understanding-results">Understanding results</a></li>
</ul>
</div>
<div class="section level1">
<h1 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h1>
<p>Numbat uses cellsnp-lite for generating SNP pileup data and eagle2 for phasing. Please follow their installation instructions and make sure their binary executables can be found in your $PATH.</p>
<ol>
<li><a href="https://github.com/single-cell-genetics/cellsnp-lite" class="external-link">cellsnp-lite</a></li>
<li><a href="https://alkesgroup.broadinstitute.org/Eagle/" class="external-link">eagle2</a></li>
<li><a href="http://www.htslib.org/" class="external-link">samtools</a></li>
</ol>
<p>Additionally, Numbat needs a common SNP VCF and phasing reference panel. You can use the 1000 Genome reference below:</p>
<ol>
<li>
<p>1000G SNP VCF</p>
<pre><code># hg38
wget https://sourceforge.net/projects/cellsnp/files/SNPlist/genome1K.phase3.SNP_AF5e2.chr1toX.hg38.vcf.gz
# hg19
wget https://sourceforge.net/projects/cellsnp/files/SNPlist/genome1K.phase3.SNP_AF5e2.chr1toX.hg19.vcf.gz</code></pre>
</li>
<li>
<p>1000G Reference Panel</p>
<pre><code># hg38
wget http://pklab.med.harvard.edu/teng/data/1000G_hg38.zip
# hg19
wget http://pklab.med.harvard.edu/teng/data/1000G_hg19.zip</code></pre>
<p><strong>Note</strong>: currently Numbat only supports human hg19 and hg38 reference.</p>
</li>
</ol>
</div>
<div class="section level1">
<h1 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h1>
<p>You can install the numbat R package via:</p>
<pre><code><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"https://github.com/kharchenkolab/numbat"</span><span class="op">)</span></code></pre>
<p>To get the most recent updates, you can install the development version:</p>
<pre><code><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"https://github.com/kharchenkolab/Numbat/tree/devel"</span><span class="op">)</span></code></pre>
</div>
<div class="section level1">
<h1 id="preparing-data">Preparing data<a class="anchor" aria-label="anchor" href="#preparing-data"></a>
</h1>
<ol><li>Prepare the allele data. Run the preprocessing script (<code>pileup_and_phase.R</code>) to count alleles and phase SNPs ``` usage: pileup_and_phase.R [-h] –label LABEL –samples SAMPLES –bams BAMS –barcodes BARCODES –gmap GMAP [–eagle EAGLE] –snpvcf SNPVCF –paneldir PANELDIR –outdir OUTDIR –ncores NCORES [–UMItag UMITAG][–cellTAG CELLTAG] [–smartseq]</li></ol>
<p>Run SNP pileup and phasing with 1000G</p>
<p>optional arguments: -h, –help show this help message and exit –label LABEL Individual label –samples SAMPLES Sample names, comma delimited –bams BAMS BAM files, one per sample, comma delimited –barcodes BARCODES Cell barcode files, one per sample, comma delimited –gmap GMAP Path to genetic map provided by Eagle2 (e.g. Eagle_v2.4.1/tables/genetic_map_hg38_withX.txt.gz) –snpvcf SNPVCF SNP VCF for pileup –paneldir PANELDIR Directory to phasing reference panel (BCF files) –outdir OUTDIR Output directory –ncores NCORES Number of cores –UMItag UMITAG UMI tag in bam. Should be Auto for 10x and XM for Slide-seq –cellTAG CELLTAG Cell tag in bam. Should be CB for 10x and XC for Slide- seq –smartseq running with smart-seq mode</p>
<pre><code>Note: If running with `--smartseq` mode, you may provide a file containing a list of bams (each as its own line) to `--bams` and a file containing a list of cell names (each as its own line) to `--barcodes`.

This will produce a file named `{sample}_allele_counts.tsv.gz` under the specified output directory, which contains cell-level phased allele counts. If multiple samples from the same individual was provided, there will be one allele count file for each sample. Other outputs include phased vcfs under `phasing/` folder and raw pileup counts under `pileup/`.

2. Prepare the expression data. Numbat takes a gene by cell integer UMI count matrix as input. You can directly use results from upstream transcriptome quantification pipelines such as 10x CellRanger.
  
3. Prepare the expression reference, which is a gene by cell type matrix of normalized expression values (raw gene counts divided by total counts). For a quick start, you may use a our HCA collection (`ref_hca`) that ships with the package. If you have matched normal cells (ideally, of various cell type) from the same patient or dataset and would like to make your own references, you may use this utility function:</code></pre>
</div>
<div class="section level1"><h1 id="count_mat-is-a-gene-x-cell-raw-count-matrices">count_mat is a gene x cell raw count matrices<a class="anchor" aria-label="anchor" href="#count_mat-is-a-gene-x-cell-raw-count-matrices"></a>
</h1></div>
<div class="section level1">
<h1 id="cell_annot-is-a-dataframe-with-columns-cell-and-cell_type">cell_annot is a dataframe with columns “cell” and “cell_type”<a class="anchor" aria-label="anchor" href="#cell_annot-is-a-dataframe-with-columns-cell-and-cell_type"></a>
</h1>
<p>ref_internal = aggregate_counts(count_mat, cell_annot)$exp_mat</p>
<pre><code>  
# Running Numbat
  
In this example (ATC2 from [Gao et al](https://www.nature.com/articles/s41587-020-00795-2)), the gene expression count matrix and allele dataframe are already prepared for you.</code></pre>
<p>library(numbat)</p>
</div>
<div class="section level1">
<h1 id="run">run<a class="anchor" aria-label="anchor" href="#run"></a>
</h1>
<p>out = run_numbat( count_mat_ATC2, # gene x cell integer UMI count matrix ref_hca, # reference expression profile, a gene x cell type normalized expression level matrix df_allele_ATC2, # allele dataframe generated by pileup_and_phase script gtf_hg38, # provided upon loading the package genetic_map_hg38, # provided upon loading the package min_cells = 20, t = 1e-3, max_iter = 2, min_LLR = 50, init_k = 3, ncores = 10, plot = TRUE, out_dir = ‘./test’ ) ``<code>**Note**: If you wish to use your own custom reference, please use the</code>aggregate_counts` function as per the example in <a href="#preparing-data">preparing data</a>.</p>
<div class="section level2">
<h2 id="run-parameters">Run parameters<a class="anchor" aria-label="anchor" href="#run-parameters"></a>
</h2>
<p>There are a few parameters you can consider tuning to a specific dataset.</p>
<p><em>CNV detection</em></p>
<ul>
<li>
<code>t</code>: the transition probability used in the HMM. A lower <code>t</code> is more appropriate for tumors with more complex copy number landscapes (from which you can expect more breakpoints) and is sometimes better for detecting subclonal events. A higher <code>t</code> is more effective for controlling false-positive rates of CNV calls.</li>
<li>
<code>gamma</code>: Overdispersion in allele counts (default: 20). For 10x data, 20 is recommended. Non-UMI protocols (e.g. SMART-Seq) usually produce noisier allele data, and a smaller value of gamma is recommended (e.g. 5).</li>
<li>
<code>min_cells</code>: minimum number of cells for which an pseudobulk HMM will be run. If the allele coverage per cell is very sparse for a dataset, then I would consider setting this threshold to be higher.</li>
<li>
<code>multi_allelic</code>: Whether to enable calling of multiallelic CNVs</li>
</ul>
<p><em>CNV filtering</em></p>
<ul>
<li>
<code>min_LLR</code>: minimum log-likelihood ratio threshold to filter CNVs by. To ensure quality of phylogeny inference, we only use confident CNVs to reconstruct the phylogeny. By default, this threshold is 50.</li>
<li>
<code>max_entropy</code>: another criteria that we use to filter CNVs before phylogeny construction. The entropy of the binary posterior quantifies the uncertainty of an event across single cells. The value can be from 0 to 1 where 1 is the least stringent.</li>
</ul>
<p><em>Phylogeny</em></p>
<ul><li>
<code>tau</code>: Stringency to simplify the mutational history (0-1). A higher <code>tau</code> produces less clones and a more simplied evolutionary history.</li></ul>
<p><em>Iterative optimization</em></p>
<ul>
<li>
<code>init_k</code>: initial number of subclusters to use for the <code>hclust</code> initialization. Numbat by default uses hierarchical clustering (<code>hclust</code>) of smoothed expression values to approximate an initial phylogeny. This will cut the initial tree into k clusters. More clusters means more resolution at the initial stage for subclonal CNV detection. By default, we set init_k to be 3.</li>
<li>
<code>max_iter</code>: maximum number of iterations. Numbat iteratively optimizes the phylogeny and copy number estimations. In practice, we find that results after 2 iterations are usually stable.<br>
</li>
<li>
<code>check_convergence</code>: stop iterating if the results have converged (based on consensus CNV segments).</li>
</ul>
<p><em>Parallelization</em></p>
<ul>
<li>
<code>ncores</code>: number of cores to use for single-cell CNV testing</li>
<li>
<code>ncores_nni</code>: number of cores to use for phylogeny inference</li>
</ul>
</div>
</div>
<div class="section level1">
<h1 id="understanding-results">Understanding results<a class="anchor" aria-label="anchor" href="#understanding-results"></a>
</h1>
<p>A detailed vignette on how to interpret and visualize Numbat results is available:</p>
<ul><li><a href="https://kharchenkolab.github.io/numbat" class="external-link">Interpreting Numbat results</a></li></ul>
<p>Numbat generates a number of files in the output folder. The file names are post-fixed with the <code>i</code>th iteration of phylogeny optimization. Here is a detailed list:</p>
<ul>
<li>
<code>gexp_roll_wide.tsv.gz</code>: window-smoothed normalized expression profiles of single cells</li>
<li>
<code>hc.rds</code>: hierarchical clustering result based on smoothed expression</li>
<li>
<code>bulk_subtrees_{i}.tsv.gz</code>: pseudobulk HMM profiles based on subtrees defined by current cell lineage tree</li>
<li>
<code>segs_consensus_{i}.tsv.gz</code>: consensus segments from subtree pseudobulk HMMs</li>
<li>
<code>bulk_clones_{i}.tsv.gz</code>: pseudobulk HMM profiles based on clones defined by current cell lineage tree</li>
<li>
<code>bulk_clones_{i}.png</code>: visualization of clone pseudobulk HMM profiles</li>
<li>
<code>exp_sc_{i}.tsv.gz</code>: single-cell expression profiles used for single-cell CNV testing</li>
<li>
<code>exp_post_{i}.tsv</code>: single-cell expression posteriors</li>
<li>
<code>allele_post_{i}.tsv</code>: single-cell allele posteriors</li>
<li>
<code>joint_post_{i}.tsv</code>: single-cell joint posteriors</li>
<li>
<code>treeUPGMA_{i}.rds</code>: UPGMA tree</li>
<li>
<code>treeNJ_{i}.rds</code>: NJ tree</li>
<li>
<code>tree_list_{i}.rds</code>: list of candidate phylogeneies in the maximum likelihood tree search</li>
<li>
<code>tree_final_{i}.rds</code>: final tree after simplification</li>
<li>
<code>mut_graph_{i}.rds</code>: final mutation history</li>
<li>
<code>clone_post_{i}.rds</code>: clone assignment and tumor versus normal classification posteriors</li>
<li>
<code>bulk_subtrees_{i}.png</code>: visualization of subtree pseudobulk HMM profiles</li>
<li>
<code>bulk_clones_{i}.png</code>: visualization of clone pseudobulk HMM profiles</li>
<li>
<code>panel_{i}.png</code>: visualization of combined phylogeny and CNV heatmap</li>
</ul>
</div>

  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing numbat</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Teng Gao <br><small class="roles"> Maintainer, author </small>  </li>
<li>Hirak Sarkar <br><small class="roles"> Author </small>  </li>
<li>Evan Biederstedt <br><small class="roles"> Author </small>  </li>
<li>Peter Kharchenko <br><small class="roles"> Author </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://app.circleci.com/pipelines/github/kharchenkolab/numbat" class="external-link"><img src="https://circleci.com/gh/kharchenkolab/numbat.svg?style=svg" alt=""></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Teng Gao, Hirak Sarkar, Evan Biederstedt, Peter Kharchenko.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
