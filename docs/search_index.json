[["_main.html", "Numbat walkthrough 0.1 Copy number landscape and single-cell phylogeny 0.2 Single-cell CNV calls 0.3 Clonal assignments 0.4 Tumor versus normal probability 0.5 Tumor phylogeny 0.6 Bulk CNV profiles 0.7 Copy number landscape and single-cell phylogeny 0.8 Single-cell CNV calls 0.9 Clonal assignments 0.10 Tumor versus normal probability 0.11 Tumor phylogeny 0.12 Bulk CNV profiles", " Numbat walkthrough In this tutorial, we will illustrate how to visualize and interpret Numbat output, using a triple-negative breast cancer dataset (TNBC1) from Gao et al. We will use pagoda2 for visualizing cells in low-dimensional expression space. # devtools::load_all(&#39;~/Numbat&#39;) library(ggplot2) library(Numbat) library(dplyr) library(glue) library(data.table) library(ggtree) library(stringr) library(tidygraph) library(patchwork) # summarize output files into a Numbat object nb = Numbat$new(out_dir = &#39;~/paper_data/numbat_out/TNBC1_demo&#39;) # read saved pagoda2 object pagoda = readRDS(&#39;~/paper_data/conos_objects/TNBC1.rds&#39;) 0.1 Copy number landscape and single-cell phylogeny As an overview, we can visualize the CNV calls in single-cells and their evolutionary relationships in an integrated view: mypal = c(&#39;gray&#39;, &quot;#377EB8&quot;, &quot;#4DAF4A&quot;, &quot;#984EA3&quot;) nb$plot_phylo_heatmap( geno_bar = TRUE, p_min = 0.9, pal_clone = mypal, multi_allelic = TRUE ) In this visualization, the single-cell phylogeny (left) is juxtaposed with a heatmap of single-cell CNV calls (right). The CNV calls are colored by the type of alterations (AMP, amplification, BAMP, balanced amplification, DEL, deletion, CNLoH, copy-neutral loss of heterozygosity). The colorbar in-between differentiates the distinct genetic populations (genotype). This tells us that the dataset mainly consists of three cell populations, a normal population (gray) and two tumor subclones (green and yellow). 0.2 Single-cell CNV calls Numbat probabilistically evaluates the presence/absence of CNVs in single cells. The cell-level CNV posteriors are stored in the nb$joint_post dataframe: head(nb$joint_post) %&gt;% select(cell, CHROM, seg, cnv_state, p_cnv, p_cnv_x, p_cnv_y) ## cell CHROM seg cnv_state p_cnv p_cnv_x p_cnv_y ## 1: TNBC1_AAACCTGCACCTTGTC-1 10 10a amp 0.43169520 0.8213868 0.13928365 ## 2: TNBC1_AAACCTGCACCTTGTC-1 10 10c loh 0.01890174 0.4958024 0.01921461 ## 3: TNBC1_AAACCTGCACCTTGTC-1 11 11b loh 0.47301842 0.4333595 0.56156802 ## 4: TNBC1_AAACCTGCACCTTGTC-1 11 11c amp 0.88050832 0.8409645 0.58105281 ## 5: TNBC1_AAACCTGCACCTTGTC-1 11 11d loh 0.91233692 0.4969244 0.91242479 ## 6: TNBC1_AAACCTGCACCTTGTC-1 12 12b loh 0.96215438 0.4972205 0.96255714 which contains cell-level information on specific CNV segments (seg), their alteration type (cnv_state), the joint posterior probability of the CNV (p_cnv), the expression-based posterior (p_cnv_x), and the allele-based posterior (p_cnv_y). We can visualize the event-specific posteriors in a expression-based tSNE embedding: plist = list() muts = c(&#39;1b&#39;, &#39;3c&#39;, &#39;4c&#39;) # muts = unique(nb$joint_post$seg_label) %&gt;% gtools::mixedsort() cnv_type = nb$joint_post %&gt;% distinct(seg, cnv_state) %&gt;% {setNames(.$cnv_state, .$seg)} for (mut in muts) { plist[[mut]] = pagoda$plotEmbedding( alpha=0.8, size=1, plot.na = F, colors = nb$joint_post %&gt;% filter(seg == mut) %&gt;% {setNames(.$p_cnv, .$cell)}, show.legend = T, mark.groups = F, plot.theme = theme_bw(), title = paste0(mut, &#39;(&#39;, cnv_type, &#39;)&#39;) ) + scale_color_gradient2(low = &#39;royalblue&#39;, mid = &#39;white&#39;, high = &#39;red3&#39;, midpoint = 0.5, limits = c(0,1), name = &#39;Posterior&#39;) } wrap_plots(plist, guides = &#39;collect&#39;) 0.3 Clonal assignments Numbat aggregates signals across subclone-specific CNVs to probabilistically assign cells to subclones. The information regarding clonal assignments are contained in the nb$clone_post dataframe. nb$clone_post %&gt;% head() %&gt;% select(cell, clone_opt, p_1, p_2, p_3, p_4) ## cell clone_opt p_1 p_2 p_3 ## 1: TNBC1_AAACCTGCACCTTGTC-1 4 5.081008e-57 2.300414e-16 7.396132e-27 ## 2: TNBC1_AAACGGGAGTCCTCCT-1 1 1.000000e+00 2.232812e-51 1.591547e-84 ## 3: TNBC1_AAACGGGTCCAGAGGA-1 4 1.427456e-81 5.475283e-09 3.109571e-26 ## 4: TNBC1_AAAGATGCAGTTTACG-1 3 2.141061e-18 2.950639e-04 6.176669e-01 ## 5: TNBC1_AAAGCAACAGGAATGC-1 4 1.704233e-51 8.305804e-09 3.074182e-30 ## 6: TNBC1_AAAGCAATCGGAATCT-1 3 3.121428e-84 1.001983e-25 1.000000e+00 ## p_4 ## 1: 1.000000e+00 ## 2: 1.744050e-65 ## 3: 1.000000e+00 ## 4: 3.820380e-01 ## 5: 1.000000e+00 ## 6: 9.979171e-24 Here clone_opt denotes the maximum likelihood assignment of a cell to a specific clone. p_{1..4} are the detailed breakdown of the posterior probability that the cell belongs to each clone, respectively. Let's visualize the clonal decomposition in a tSNE embedding. pagoda$plotEmbedding( alpha=0.8, size=1, groups = nb$clone_post %&gt;% {setNames(.$clone_opt, .$cell)}, plot.na = F, plot.theme = theme_bw(), title = &#39;Genotypes&#39;, pal = mypal ) 0.4 Tumor versus normal probability Combining evidence from all CNVs, Numbat derives an aneuploidy probability for each cell to distinguish tumor versus normal cells. We can visualize the posterior aneuploidy probability based on expression evidence only, allele evidence only, and jointly: p_joint = pagoda$plotEmbedding( alpha=0.8, size=1, colors = nb$clone_post %&gt;% {setNames(.$p_cnv, .$cell)}, plot.na = F, plot.theme = theme_bw(), title = &#39;Joint&#39;, ) + scale_color_gradient2(low = &#39;royalblue&#39;, mid = &#39;white&#39;, high = &#39;red3&#39;, midpoint = 0.5, name = &#39;Posterior&#39;) p_allele = pagoda$plotEmbedding( alpha=0.8, size=1, colors = nb$clone_post %&gt;% {setNames(.$p_cnv_x, .$cell)}, plot.na = F, plot.theme = theme_bw(), title = &#39;Expnbsion&#39;, ) + scale_color_gradient2(low = &#39;royalblue&#39;, mid = &#39;white&#39;, high = &#39;red3&#39;, midpoint = 0.5, name = &#39;Posterior&#39;) p_expr = pagoda$plotEmbedding( alpha=0.8, size=1, colors = nb$clone_post %&gt;% {setNames(.$p_cnv_y, .$cell)}, plot.na = F, show.legend = T, plot.theme = theme_bw(), title = &#39;Allele&#39;, ) + scale_color_gradient2(low = &#39;royalblue&#39;, mid = &#39;white&#39;, high = &#39;red3&#39;, midpoint = 0.5, name = &#39;Posterior&#39;) (p_expr | p_allele | p_joint) + plot_layout(guides = &#39;collect&#39;) Both expression and allele signal clearly separate the tumor and normal cells. 0.5 Tumor phylogeny The clone-level mutational history constructed by Numbat can also be visualized. Here the nodes represent clones (each carrying a distinct genotype) and edges represent mutational events. nb$plot_mut_history(pal_clone = mypal) 0.6 Bulk CNV profiles To get a better sense of the raw CNV signals, we can visualize the pseudobulk CNV profiles of the respective clones by the below function: nb$plot_bulks() In this tutorial, we will illustrate how to visualize and interpret Numbat output, using a triple-negative breast cancer dataset (TNBC1) from Gao et al. We will use pagoda2 for visualizing cells in low-dimensional expression space. # devtools::load_all(&#39;~/Numbat&#39;) library(ggplot2) library(Numbat) library(dplyr) library(glue) library(data.table) library(ggtree) library(stringr) library(tidygraph) library(patchwork) # summarize output files into a Numbat object nb = Numbat$new(out_dir = &#39;~/paper_data/numbat_out/TNBC1_demo&#39;) # read saved pagoda2 object pagoda = readRDS(&#39;~/paper_data/conos_objects/TNBC1.rds&#39;) 0.7 Copy number landscape and single-cell phylogeny As an overview, we can visualize the CNV calls in single-cells and their evolutionary relationships in an integrated view: mypal = c(&#39;gray&#39;, &quot;#377EB8&quot;, &quot;#4DAF4A&quot;, &quot;#984EA3&quot;) nb$plot_phylo_heatmap( geno_bar = TRUE, p_min = 0.9, pal_clone = mypal, multi_allelic = TRUE ) In this visualization, the single-cell phylogeny (left) is juxtaposed with a heatmap of single-cell CNV calls (right). The CNV calls are colored by the type of alterations (AMP, amplification, BAMP, balanced amplification, DEL, deletion, CNLoH, copy-neutral loss of heterozygosity). The colorbar in-between differentiates the distinct genetic populations (genotype). This tells us that the dataset mainly consists of three cell populations, a normal population (gray) and two tumor subclones (green and yellow). 0.8 Single-cell CNV calls Numbat probabilistically evaluates the presence/absence of CNVs in single cells. The cell-level CNV posteriors are stored in the nb$joint_post dataframe: head(nb$joint_post) %&gt;% select(cell, CHROM, seg, cnv_state, p_cnv, p_cnv_x, p_cnv_y) ## cell CHROM seg cnv_state p_cnv p_cnv_x p_cnv_y ## 1: TNBC1_AAACCTGCACCTTGTC-1 10 10a amp 0.43169520 0.8213868 0.13928365 ## 2: TNBC1_AAACCTGCACCTTGTC-1 10 10c loh 0.01890174 0.4958024 0.01921461 ## 3: TNBC1_AAACCTGCACCTTGTC-1 11 11b loh 0.47301842 0.4333595 0.56156802 ## 4: TNBC1_AAACCTGCACCTTGTC-1 11 11c amp 0.88050832 0.8409645 0.58105281 ## 5: TNBC1_AAACCTGCACCTTGTC-1 11 11d loh 0.91233692 0.4969244 0.91242479 ## 6: TNBC1_AAACCTGCACCTTGTC-1 12 12b loh 0.96215438 0.4972205 0.96255714 which contains cell-level information on specific CNV segments (seg), their alteration type (cnv_state), the joint posterior probability of the CNV (p_cnv), the expression-based posterior (p_cnv_x), and the allele-based posterior (p_cnv_y). We can visualize the event-specific posteriors in a expression-based tSNE embedding: plist = list() muts = c(&#39;1b&#39;, &#39;3c&#39;, &#39;4c&#39;) # muts = unique(nb$joint_post$seg_label) %&gt;% gtools::mixedsort() cnv_type = nb$joint_post %&gt;% distinct(seg, cnv_state) %&gt;% {setNames(.$cnv_state, .$seg)} for (mut in muts) { plist[[mut]] = pagoda$plotEmbedding( alpha=0.8, size=1, plot.na = F, colors = nb$joint_post %&gt;% filter(seg == mut) %&gt;% {setNames(.$p_cnv, .$cell)}, show.legend = T, mark.groups = F, plot.theme = theme_bw(), title = paste0(mut, &#39;(&#39;, cnv_type, &#39;)&#39;) ) + scale_color_gradient2(low = &#39;royalblue&#39;, mid = &#39;white&#39;, high = &#39;red3&#39;, midpoint = 0.5, limits = c(0,1), name = &#39;Posterior&#39;) } wrap_plots(plist, guides = &#39;collect&#39;) 0.9 Clonal assignments Numbat aggregates signals across subclone-specific CNVs to probabilistically assign cells to subclones. The information regarding clonal assignments are contained in the nb$clone_post dataframe. nb$clone_post %&gt;% head() %&gt;% select(cell, clone_opt, p_1, p_2, p_3, p_4) ## cell clone_opt p_1 p_2 p_3 ## 1: TNBC1_AAACCTGCACCTTGTC-1 4 5.081008e-57 2.300414e-16 7.396132e-27 ## 2: TNBC1_AAACGGGAGTCCTCCT-1 1 1.000000e+00 2.232812e-51 1.591547e-84 ## 3: TNBC1_AAACGGGTCCAGAGGA-1 4 1.427456e-81 5.475283e-09 3.109571e-26 ## 4: TNBC1_AAAGATGCAGTTTACG-1 3 2.141061e-18 2.950639e-04 6.176669e-01 ## 5: TNBC1_AAAGCAACAGGAATGC-1 4 1.704233e-51 8.305804e-09 3.074182e-30 ## 6: TNBC1_AAAGCAATCGGAATCT-1 3 3.121428e-84 1.001983e-25 1.000000e+00 ## p_4 ## 1: 1.000000e+00 ## 2: 1.744050e-65 ## 3: 1.000000e+00 ## 4: 3.820380e-01 ## 5: 1.000000e+00 ## 6: 9.979171e-24 Here clone_opt denotes the maximum likelihood assignment of a cell to a specific clone. p_{1..4} are the detailed breakdown of the posterior probability that the cell belongs to each clone, respectively. Let's visualize the clonal decomposition in a tSNE embedding. pagoda$plotEmbedding( alpha=0.8, size=1, groups = nb$clone_post %&gt;% {setNames(.$clone_opt, .$cell)}, plot.na = F, plot.theme = theme_bw(), title = &#39;Genotypes&#39;, pal = mypal ) 0.10 Tumor versus normal probability Combining evidence from all CNVs, Numbat derives an aneuploidy probability for each cell to distinguish tumor versus normal cells. We can visualize the posterior aneuploidy probability based on expression evidence only, allele evidence only, and jointly: p_joint = pagoda$plotEmbedding( alpha=0.8, size=1, colors = nb$clone_post %&gt;% {setNames(.$p_cnv, .$cell)}, plot.na = F, plot.theme = theme_bw(), title = &#39;Joint&#39;, ) + scale_color_gradient2(low = &#39;royalblue&#39;, mid = &#39;white&#39;, high = &#39;red3&#39;, midpoint = 0.5, name = &#39;Posterior&#39;) p_allele = pagoda$plotEmbedding( alpha=0.8, size=1, colors = nb$clone_post %&gt;% {setNames(.$p_cnv_x, .$cell)}, plot.na = F, plot.theme = theme_bw(), title = &#39;Expnbsion&#39;, ) + scale_color_gradient2(low = &#39;royalblue&#39;, mid = &#39;white&#39;, high = &#39;red3&#39;, midpoint = 0.5, name = &#39;Posterior&#39;) p_expr = pagoda$plotEmbedding( alpha=0.8, size=1, colors = nb$clone_post %&gt;% {setNames(.$p_cnv_y, .$cell)}, plot.na = F, show.legend = T, plot.theme = theme_bw(), title = &#39;Allele&#39;, ) + scale_color_gradient2(low = &#39;royalblue&#39;, mid = &#39;white&#39;, high = &#39;red3&#39;, midpoint = 0.5, name = &#39;Posterior&#39;) (p_expr | p_allele | p_joint) + plot_layout(guides = &#39;collect&#39;) Both expression and allele signal clearly separate the tumor and normal cells. 0.11 Tumor phylogeny The clone-level mutational history constructed by Numbat can also be visualized. Here the nodes represent clones (each carrying a distinct genotype) and edges represent mutational events. nb$plot_mut_history(pal_clone = mypal) 0.12 Bulk CNV profiles To get a better sense of the raw CNV signals, we can visualize the pseudobulk CNV profiles of the respective clones by the below function: nb$plot_bulks() "]]
